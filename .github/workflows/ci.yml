name: CI
on: [pull_request]

jobs:
  node-version:
    timeout-minutes: 5
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.node-version.outputs.result }}
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      # This is a container action, so only linux can be used
      - id: node-version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq '.runs.using | sub("^node", "")' action.yml

  lint:
    needs: node-version
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4
        with:
          aqua_version: v2.53.9
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ needs.node-version.outputs.result }}
          cache: npm
      - name: Install Node.js dependencies
        run: |
          npm ci
      - name: Run node lint
        id: node-lint
        continue-on-error: false
        run: |
          npm run lint
      - name: Run ghalint for action.yml
        id: ghalint
        continue-on-error: false
        run: ghalint act
      - name: Error handling
        if: ${{ steps.node-lint.outcome == 'failure' || steps.ghalint.outcome == 'failure' }}
        run: |
          echo "Linting errors found"
          exit 1

  test:
    timeout-minutes: 10
    needs: node-version
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ needs.node-version.outputs.result }}
          cache: npm
      - name: Install Node.js dependencies
        run: |
          npm ci
      - name: Run test
        run: |
          npm run test
      - name: Run package
        run: |
          npm run package
      - name: Run action
        uses: ./
        id: system-info
      - name: Show action outputs
        run: |
          echo '${{ toJSON(steps.system-info.outputs) }}'
